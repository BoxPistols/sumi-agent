# PDFエクスポート設計ドキュメント

RedactProでは、PDFエクスポートに「ブラウザの印刷機能（Print-to-PDF）」を活用した独自のスキームを採用しています。このドキュメントでは、その設計意図、メリット、および実装詳細について解説します。

## 1. 背景と課題

クライアントサイドJavaScriptで日本語PDFを生成する場合、一般的に以下の課題があります。

- **日本語フォントの壁**: `jsPDF` 等のライブラリでは日本語フォントをBase64形式で埋め込む必要があり、アプリのファイルサイズが数MB単位で増大する。
- **レイアウトの再現性**: HTML/CSSで構築したプレビュー画面を正確にPDF化するには、`html2canvas` 等の重い依存ライブラリが必要となり、レンダリング結果もブラウザによって不安定になりやすい。
- **プライバシー**: サーバーサイドでPDFを生成する場合、マスキング済みの機密データをサーバーに送信する必要があり、本プロジェクトの「クライアントサイド完結」という基本方針に反する。

## 2. 採用したソリューション：HTMLベースの印刷スキーム

これらの課題を解決するため、RedactProでは以下のフローを採用しています。

1. **自己印刷型HTMLの生成**:
   - マスキング済みデータとCSS（@media print対応）を含む完全なHTMLをメモリ上で生成。
   - `window.onload` 時に自動的に `window.print()` を実行するスクリプトを注入。
2. **Blob URLによるセキュアな表示**:
   - 生成したHTMLを `Blob` オブジェクトに変換し、`URL.createObjectURL` を使って一時的なURLを発行。
   - `window.open()` で新しいタブとして開く。
3. **OS/ブラウザ標準機能への委任**:
   - ユーザーは使い慣れたOS標準の印刷ダイアログから「PDFとして保存」を選択。
   - これにより、システムにインストール済みのフォントが適切に使用され、軽量かつ高品質なPDFが生成される。

## 3. 実装のポイント

### 3.1 印刷専用CSS

`@media print` を活用し、背景の非表示、余白の最適化（`@page { margin: 15mm }`）、フォントサイズの調整を行っています。

### 3.2 ライフサイクル管理

`generateExport` 関数で生成されたHTMLには以下のスクリプトが含まれています：

```javascript
window.onload = function () {
  window.print()
  // 印刷ダイアログを閉じた後にタブを自動的に閉じる（UX向上）
  setTimeout(() => {
    window.close()
  }, 1000)
}
```

### 3.3 セキュリティとクリーンアップ

`triggerDownload` 関数内で `URL.createObjectURL` を使用し、ダウンロードではなくブラウザ内表示に切り替えることで、不要なHTMLファイルがユーザーのローカルディスクに蓄積されるのを防いでいます。

## 4. このスキームのメリット

- **ゼロ・ディペンデンシー**: PDF生成専用の巨大なライブラリが不要。
- **完璧な日本語対応**: ブラウザがOSのフォントを利用するため、文字化けやフォント埋め込みの問題が皆無。
- **WYSIWYG**: ブラウザのレンダリング結果がそのままPDFになるため、プレビューとの乖離が少ない。
- **オフライン動作**: 外部サーバーへの通信が一切発生しない。

---

最終更新: 2026年2月14日
